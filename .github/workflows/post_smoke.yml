name: post_smoke

on:
  workflow_run:
    workflows: ["smoke"]
    types:
      - completed

jobs:
  post_smoke:
    # Sadece başarılı smoke run'larında ve main branch için çalışsın.
    if: ${{ github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'main' }}
    runs-on: ubuntu-latest

    permissions:
      contents: read
      actions: write

    steps:
      - name: Checkout smoke commit
        uses: actions/checkout@v4
        with:
          repository: ${{ github.event.workflow_run.head_repository.full_name }}
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Prepare ci docs directory
        run: mkdir -p docs/ci

      - name: Write last_smoke.txt
        run: |
          {
            echo "run_id=${{ github.event.workflow_run.id }}"
            echo "conclusion=${{ github.event.workflow_run.conclusion }}"
            echo "head_branch=${{ github.event.workflow_run.head_branch }}"
            echo "head_sha=${{ github.event.workflow_run.head_sha }}"
          } > docs/ci/last_smoke.txt

      - name: Write last_sha256.txt
        run: |
          echo "${{ github.event.workflow_run.head_sha }}" | sha256sum > docs/ci/last_sha256.txt

      - name: Append DoD line
        run: |
          echo "PASS 19090=200 38888=200 E2E=200 run_id=${{ github.event.workflow_run.id }} sha=${{ github.event.workflow_run.head_sha }}" >> docs/ci/DoD.txt

      - name: Debug docs/ci
        run: |
          echo "pwd:"
          pwd
          echo "ls -R:"
          ls -R
          echo "docs/ci listing:"
          ls -l docs/ci || echo "docs/ci not found"

      - name: Upload post_smoke artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dod-artifacts
          path: docs/ci/*
          if-no-files-found: error
