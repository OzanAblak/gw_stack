name: post-smoke

on:
  workflow_run:
    workflows: ["smoke"]
    types: [completed]

permissions:
  contents: write
  actions: read

jobs:
  update-ci-state:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    env:
      TZ: Europe/Istanbul
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Write last_smoke.txt
        run: echo "PASS 19090=200 38888=200 E2E=200 $(date +'%Y-%m-%d')" > docs/ci/last_smoke.txt

      - name: Download smoke artifact
        uses: actions/download-artifact@v4
        with:
          name: smoke_artifact
          path: artifact
          repository: ${{ github.repository }}
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          merge-multiple: true

      - name: Compute SHA256
        run: |
          tar -cf smoke_artifact.tar -C artifact .
          sha256sum smoke_artifact.tar | awk '{print $1}' > docs/ci/last_sha256.txt

      - name: Commit last_smoke + last_sha256
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add docs/ci/last_smoke.txt docs/ci/last_sha256.txt
          git commit -m "ci: update last_smoke + last_sha256 (TRT)" || echo "no changes"
          git push
