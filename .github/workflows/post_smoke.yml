  - name: Compute artifact SHA256
    shell: bash
    run: |
      set -euo pipefail
      RUN_ID=$(jq -r '.workflow_run.id' "$GITHUB_EVENT_PATH")
      ART_JSON=$(curl -s -H "Authorization: Bearer $GITHUB_TOKEN" \
        "https://api.github.com/repos/$GITHUB_REPOSITORY/actions/runs/$RUN_ID/artifacts?per_page=100")

      AID=$(python3 - <<'PY' <<<"$ART_JSON"
import sys, json
data = json.loads(sys.stdin.read() or "{}")
aid = ""
for a in data.get("artifacts", []):
    if a.get("name") == "smoke_artifact" and not a.get("expired", False):
        aid = str(a.get("id", ""))
        break
print(aid)
PY
)
      if [ -z "$AID" ]; then
        echo "no_artifact" > docs/ci/last_sha256.txt
      else
        curl -sL -H "Authorization: Bearer $GITHUB_TOKEN" -H "Accept: application/octet-stream" \
             "https://api.github.com/repos/$GITHUB_REPOSITORY/actions/artifacts/$AID/zip" -o artifact.zip
        sha256sum artifact.zip | awk '{print $1}' > docs/ci/last_sha256.txt
      fi
