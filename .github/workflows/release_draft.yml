name: release_draft

on:
  workflow_run:
    workflows: ["post_smoke"]
    types:
      - completed

permissions:
  contents: write
  actions: read

jobs:
  release_draft:
    if: github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest

    env:
      REL_VERSION_PREFIX: v0.1.1-draft

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download CI artifacts (DoD bundle)
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          run-id: ${{ github.event.workflow_run.id }}
          name: ci_artifacts
          path: ci_artifacts

      - name: Show DoD bundle
        run: |
          ls -R
          echo "=== DoD.txt ==="
          cat ci_artifacts/DoD.txt || true
          echo "=== last_smoke.txt ==="
          cat ci_artifacts/last_smoke.txt || true
          echo "=== last_sha256.txt ==="
          cat ci_artifacts/last_sha256.txt || true

      - name: Export release env
        run: |
          echo "REL_TAG=${{ env.REL_VERSION_PREFIX }}-${{ github.run_id }}" >> $GITHUB_ENV
          echo "REL_TYPE=Pre-release" >> $GITHUB_ENV
          echo "REL_BRANCH=${{ github.event.workflow_run.head_branch }}" >> $GITHUB_ENV
          echo "REL_COMMIT=${{ github.event.workflow_run.head_sha }}" >> $GITHUB_ENV
          echo "REL_URL=https://github.com/${{ github.repository }}/releases/tag/${{ env.REL_VERSION_PREFIX }}-${{ github.run_id }}" >> $GITHUB_ENV
          echo "REL_DATE=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_ENV

          # CI zinciri alanları (basit seviye)
          echo "SMOKE_RUN_ID=${{ github.event.workflow_run.id }}" >> $GITHUB_ENV
          echo "SMOKE_STATUS=${{ github.event.workflow_run.conclusion }}" >> $GITHUB_ENV

          echo "POST_SMOKE_RUN_ID=${{ github.event.workflow_run.id }}" >> $GITHUB_ENV
          echo "POST_SMOKE_STATUS=${{ github.event.workflow_run.conclusion }}" >> $GITHUB_ENV

          echo "RELEASE_DRAFT_RUN_ID=${{ github.run_id }}" >> $GITHUB_ENV
          echo "RELEASE_DRAFT_STATUS=success" >> $GITHUB_ENV

          echo "SITE_CHECK_RUN_ID=" >> $GITHUB_ENV
          echo "SITE_CHECK_STATUS=" >> $GITHUB_ENV

          echo "CI_PIPELINE_STATUS=ALL PASS" >> $GITHUB_ENV

          echo "DOD_STATUS=PASS" >> $GITHUB_ENV

      - name: Generate release body (FAZ-44)
        shell: pwsh
        run: ./scripts/generate_release_body.ps1

      - name: Create or update pre-release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="$REL_TAG"

          if gh release view "$TAG" >/dev/null 2>&1; then
            echo "Release $TAG exists, editing..."
            gh release edit "$TAG" \
              --prerelease \
              --notes-file docs/faz-43/release_body_generated.md
          else
            echo "Creating release $TAG"
            gh release create "$TAG" \
              --target "$REL_BRANCH" \
              --prerelease \
              --title "$TAG" \
              --notes-file docs/faz-43/release_body_generated.md
          fi

          # DoD bundle'ı asset olarak yükle
          if [ -f ci_artifacts/DoD.txt ]; then
            gh release upload "$TAG" ci_artifacts/DoD.txt --clobber
          fi
          if [ -f ci_artifacts/last_smoke.txt ]; then
            gh release upload "$TAG" ci_artifacts/last_smoke.txt --clobber
          fi
          if [ -f ci_artifacts/last_sha256.txt ]; then
            gh release upload "$TAG" ci_artifacts/last_sha256.txt --clobber
          fi
