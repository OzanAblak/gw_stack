name: post_smoke

on:
  workflow_run:
    workflows: ["smoke"]
    types:
      - completed

jobs:
  post_smoke:
    if: ${{ github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'main' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: write

    steps:
      - name: Checkout smoke commit
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Prepare ci docs directory
        run: |
          mkdir -p docs/ci

      - name: Write last_smoke.txt
        run: |
          {
            echo "run_id=${{ github.event.workflow_run.id }}";
            echo "conclusion=${{ github.event.workflow_run.conclusion }}";
            echo "head_branch=${{ github.event.workflow_run.head_branch }}";
            echo "head_sha=${{ github.event.workflow_run.head_sha }}";
          } > docs/ci/last_smoke.txt

      - name: Write last_sha256.txt
        run: |
          echo "${{ github.event.workflow_run.head_sha }}" | sha256sum | awk '{print $1}' > docs/ci/last_sha256.txt

      - name: Append DoD line
        run: |
          date_utc=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          echo "PASS 19090=200 38888=200 E2E=200 SMOKE_RUN_ID=${{ github.event.workflow_run.id }} SHA=${{ github.event.workflow_run.head_sha }} DATE=${date_utc}" >> docs/ci/DoD.txt

      - name: List docs/ci before upload
        run: |
          echo "docs/ci contents:"
          ls -R docs/ci

      - name: Upload post_smoke artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dod-artifacts
          path: docs/ci/**
          if-no-files-found: error
