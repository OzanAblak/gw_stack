name: release-draft

on:
  workflow_dispatch:
  workflow_run:
    workflows: ["post-smoke"]
    types: [completed]

permissions:
  contents: write
  actions: read

jobs:
  draft:
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    env:
      TZ: Europe/Istanbul
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Read CI state
        id: read
        run: |
          echo "smoke=$(cat docs/ci/last_smoke.txt)" >> $GITHUB_OUTPUT
          echo "sha=$(cat docs/ci/last_sha256.txt)" >> $GITHUB_OUTPUT

      - name: Ensure draft pre-release
        uses: actions/github-script@v7
        env:
          SMOKE: ${{ steps.read.outputs.smoke }}
          SHA: ${{ steps.read.outputs.sha }}
        with:
          script: |
            const {owner, repo} = context.repo;
            const tag = `v0.1.1-draft-${context.runId}`;
            const name = `GW Stack FAZ-29 draft (${context.runId})`;
            const body = `- last_smoke: ${process.env.SMOKE}\n- last_sha256: ${process.env.SHA}`;
            try {
              const rel = await github.rest.repos.getReleaseByTag({owner, repo, tag});
              await github.rest.repos.updateRelease({
                owner, repo, release_id: rel.data.id, name, body, draft: true, prerelease: true
              });
            } catch (e) {
              if (e.status === 404) {
                await github.rest.repos.createRelease({
                  owner, repo, tag_name: tag, name, body, draft: true, prerelease: true, target_commitish: 'main'
                });
              } else {
                throw e;
              }
            }
