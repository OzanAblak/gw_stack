name: release_draft

on:
  workflow_dispatch:
  workflow_run:
    workflows: ["post_smoke"]
    types: [completed]
    branches: ["main"]

jobs:
  release_draft:
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Compute TAG and RUN_ID
        shell: bash
        run: |
          set -euo pipefail
          base="v0.1.1-draft"
          if [[ "${{ github.event_name }}" == "workflow_run" ]]; then
            echo "TAG=${base}-${{ github.event.workflow_run.id }}" >> "$GITHUB_ENV"
            echo "RUN_ID=${{ github.event.workflow_run.id }}" >> "$GITHUB_ENV"
          else
            echo "TAG=${base}-${{ github.run_id }}" >> "$GITHUB_ENV"
            echo "RUN_ID=" >> "$GITHUB_ENV"
          fi

      - name: Ensure draft release exists
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if gh release view "$TAG" >/dev/null 2>&1; then
            echo "Draft exists: $TAG"
          else
            gh release create "$TAG" --draft --title "$TAG" --notes "Automated draft release."
          fi

      - name: Download DoD artifacts from post_smoke run
        if: env.RUN_ID != ''
        env:
          RUN_ID: ${{ env.RUN_ID }}
        run: |
          mkdir -p dist/release_assets
          gh run download "$RUN_ID" -n post_smoke_artifacts -D dist/release_assets || echo "No artifacts found"

      - name: Upload assets to draft release
        env:
          GITHUB_TOKEN: ${{ secret_
