name: release_draft

on:
  workflow_dispatch:
  workflow_run:
    workflows: ["post_smoke"]
    types: [completed]
    branches: ["main"]

jobs:
  release_draft:
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Compute TAG and RUN_ID
        shell: bash
        run: |
          set -euo pipefail
          base="v0.1.1-draft"
          if [[ "${{ github.event_name }}" == "workflow_run" ]]; then
            echo "TAG=${base}-${{ github.event.workflow_run.id }}" >> "$GITHUB_ENV"
            echo "RUN_ID=${{ github.event.workflow_run.id }}" >> "$GITHUB_ENV"
          else
            echo "TAG=${base}-${{ github.run_id }}" >> "$GITHUB_ENV"
            echo "RUN_ID=" >> "$GITHUB_ENV"
          fi
          mkdir -p dist/release_assets

      - name: Ensure draft release exists
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          if gh release view "$TAG" >/dev/null 2>&1; then
            echo "Draft exists: $TAG"
          else
            gh release create "$TAG" --draft --title "$TAG" --notes "Automated draft release."
          fi

      - name: Download DoD artifacts from post_smoke run
        if: env.RUN_ID != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RUN_ID: ${{ env.RUN_ID }}
        run: |
          set -euo pipefail
          gh run download "$RUN_ID" -n post_smoke_artifacts -D dist/release_assets || echo "NO_ARTIFACTS"

      - name: Fallback: create DoD artifacts from repo if missing
        shell: bash
        run: |
          set -euo pipefail
          if ! compgen -G "dist/release_assets/last_smoke.txt" > /dev/null; then
            echo "Rebuilding DoD artifacts from docs/ci/DoD.txt"
            grep -Eo "PASS .*" docs/ci/DoD.txt | head -n1 > dist/release_assets/last_smoke.txt
            python - <<'PY'
import hashlib, pathlib
p = pathlib.Path("dist/release_assets/last_smoke.txt")
d = p.read_bytes()
pathlib.Path("dist/release_assets/last_sha256.txt").write_text(hashlib.sha256(d).hexdigest())
PY
          fi

      - name: Debug assets dir
        shell: bash
        run: |
          set -euo pipefail
          ls -l dist/release_assets || true
          for f in dist/release_assets/*; do
            [ -f "$f" ] && echo "$(basename "$f") SIZE=$(wc -c <"$f")"
          done

      - name: Upload assets to draft release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          if compgen -G "dist/release_assets/*" > /dev/null; then
            gh release upload "$TAG" dist/release_assets/* --clobber
          else
            echo "No assets to upload"
            exit 1
          fi

      - name: Show release summary
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release view "$TAG" --json tagName,isDraft,isPrerelease,assets,url --template '{{.tagName}} DRAFT={{.isDraft}} PRE={{.isPrerelease}} ASSETS={{len .assets}} URL={{.url}}'
