name: release_draft

on:
  workflow_dispatch:
  workflow_run:
    workflows: ["post_smoke"]
    types:
      - completed

jobs:
  release_draft:
    # workflow_dispatch ise her zaman çalışsın,
    # workflow_run ise sadece başarılı post_smoke + main için çalışsın.
    if: >
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'workflow_run' &&
       github.event.workflow_run.conclusion == 'success' &&
       github.event.workflow_run.head_branch == 'main')

    runs-on: ubuntu-latest

    permissions:
      contents: write
      actions: read

    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set variables
        id: vars
        run: |
          if [ "${{ github.event_name }}" = "workflow_run" ]; then
            echo "SOURCE_RUN_ID=${{ github.event.workflow_run.id }}" >> "$GITHUB_OUTPUT"
            echo "SOURCE_SHA=${{ github.event.workflow_run.head_sha }}" >> "$GITHUB_OUTPUT"
            echo "SOURCE_BRANCH=${{ github.event.workflow_run.head_branch }}" >> "$GITHUB_OUTPUT"
          else
            echo "SOURCE_RUN_ID=${{ github.run_id }}" >> "$GITHUB_OUTPUT"
            echo "SOURCE_SHA=${{ github.sha }}" >> "$GITHUB_OUTPUT"
            echo "SOURCE_BRANCH=${{ github.ref_name }}" >> "$GITHUB_OUTPUT"
          fi

      - name: Download DoD artifacts from post_smoke
        if: ${{ github.event_name == 'workflow_run' }}
        uses: actions/download-artifact@v4
        with:
          github-token: ${{ github.token }}
          run-id: ${{ github.event.workflow_run.id }}
          name: dod-artifacts
          path: ci_artifacts


      - name: Generate fallback DoD for manual run
        if: ${{ github.event_name == 'workflow_dispatch' }}
        run: |
          mkdir -p ci_artifacts
          {
            echo "Manual release_draft run"
            echo "run_id=${{ github.run_id }}"
            echo "sha=${{ github.sha }}"
          } > ci_artifacts/DoD.txt

      - name: List ci_artifacts
        run: |
          echo "Listing ci_artifacts directory (if it exists):"
          if [ -d "ci_artifacts" ]; then
            ls -R ci_artifacts
          else
            echo "ci_artifacts directory not found"
          fi

      - name: Compute release tag
        id: tag
        run: |
          VERSION="v0.1.1-draft-${{ github.run_id }}"
          echo "TAG=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Create or update draft release
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ steps.tag.outputs.TAG }}
          name: ${{ steps.tag.outputs.TAG }}
          draft: true
          prerelease: false
          allowUpdates: true
          artifacts: "ci_artifacts/*.txt"
          artifactErrorsFailBuild: true
          token: ${{ env.GH_TOKEN }}
